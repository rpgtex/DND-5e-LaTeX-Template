\ExplSyntaxOn

\ifpkglayout

\RequirePackage[titles]{tocloft}
\RequirePackage{titlesec}	% Used to adjust (sub)section formatting

\iftoggle{multitoc}{%
  \RequirePackage[toc]{multitoc}
}{}

%Remove Numbering (If you want Numbering set secnumdepth to the appropriate depth)
\setcounter{secnumdepth}{-1}

% Chapter
\titleformat {\chapter}
  { \l__dnd_font_title_tl \Huge \color {titlered} } % format
  { \thechapter \quad } % label
  { 0pt } % sep
  {} % before-code

\titlespacing* { \chapter }
  { 0pt  } % left
  { 0pt  } % before-sep
  { 20pt } % after-sep

%\ifdef{\cftchapfont}{%
%  \renewcommand \cftchapfont { \color { titlered } \l__dnd_font_title_tl \bfseries }
%}{}

% Section
\titleformat {\section}
  { \l__dnd_font_title_tl \LARGE \color {titlered} } % format
  { \thesection \quad } % label
  { 0pt } % sep
  { \RaggedRight \nopagebreak  } % before-code

% \titlespacing* {\section}
%   { 0pt } % left
%   { 1.5ex plus .2ex minus .2ex } % before-sep
%   { 0pt } % after-sep

% Subsection
\titleformat{\subsection}
  { \l__dnd_font_title_tl \Large \color {titlered} } % format
  { \thesubsection \quad } % label
  { 0pt } % sep
  { \RaggedRight \nopagebreak } % before-code
  [ \titleline { \color {titlegold} \titlerule [1pt] } ] % after-code

% \titlespacing* {\subsection}
%   {   0pt } % left
%   { 1.6ex } % before-sep
%   { .75ex } % after-sep

% Subsubsection
\titleformat {\subsubsection}
  { \l__dnd_font_title_tl \large \color {titlered} } % format
  { \thesubsubsection \quad } % label
  { 0pt } % sep
  { \RaggedRight \nopagebreak } % before-code

% \titlespacing* {\subsubsection}
%   { 0pt } % left
%   { 1.7ex plus .2ex minus .2ex } % before-sep
%   { 0pt } % after-sep

% Paragraph
\titleformat{\paragraph}[runin]
{\normalfont\normalsize\bfseries\slshape}{\theparagraph\quad}{0pt}{}[.]
\titlespacing*{\paragraph}
{0pt}{\parskip}{\wordsep}

% Subparagraph
\titleformat{\subparagraph}[runin]
{\normalfont\normalsize\bfseries\slshape}{\thesubparagraph\quad}{0pt}{}[.]
\titlespacing*{\subparagraph}
{\parindent}{\parskip}{\wordsep}

\fi % \ifpkglayout

\ExplSyntaxOff

% Special command for magic items, traps, and the like.
\newcommand{\subtitlesection}[2]{
  \subsubsection{#1}\vspace{-1ex}
  \textit{#2}\vspace{1ex}\par
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Map Areas and their References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Labelling helpers
\newcommand{\AreaLabel@Prefix}{area}
\newcommand{\SetAreaLabelPrefix}[1]{%
\renewcommand{\AreaLabel@Prefix}{#1}}

\newcounter{Area}
\newcommand\ResetAreas{%
\setcounter{Area}{0}}

\NewDocumentCommand\area{mo}{%
  \refstepcounter{Area}%
  \IfNoValueTF{#2}%
    {\label{\AreaLabel@Prefix:#1}}%
    {\label{\AreaLabel@Prefix:#2}}%
  \subsection{\arabic{Area}. #1}%
}

% defines sub-areas, like '5a', '5b'
\newcounter{SubArea}[Area]

\NewDocumentCommand\subarea{mo}{%
  \refstepcounter{SubArea}%
  \IfNoValueTF{#2}%
    {\label{\AreaLabel@Prefix:#1}}%
    {\label{\AreaLabel@Prefix:#2}}%
  \subsubsection{\arabic{Area}\alph{SubArea}. #1}%
}

% sub area references should be '5a', '5b', not '1', '2'
\renewcommand\p@SubArea{\arabic{Area}}
\renewcommand\theSubArea{\alph{SubArea}}

\newcounter{DetailArea}[subsection]
\newcommand{\DetailArea@Prefix}{}
\newcommand{\SetDetailAreaPrefix}[1]{\renewcommand{\DetailArea@Prefix}
      {#1--\arabic{DetailArea}\par\expandafter\ignorespaces\noindent}}
      
